{
    "亏损或恶化": [
        "\nSELECT \n    COALESCE(t2025.省办, t2024.省办) AS 省办,\n    FORMAT(t2025.收入, 'N') AS [{start}-{end}收入],\n    FORMAT(t2025.利润, 'N') AS [{start}-{end}利润],\n    FORMAT(t2025.利润率 * 100, 'N2') + '%' AS [{start}-{end}利润率],\n    FORMAT(t2024.收入, 'N') AS [{prev_start}-{prev_end}收入],\n    FORMAT(t2024.利润, 'N') AS [{prev_start}-{prev_end}利润],\n    FORMAT(t2024.利润率 * 100, 'N2') + '%' AS [{prev_start}-{prev_end}利润率],\n    FORMAT((t2025.利润率 - t2024.利润率) * 100, 'N2') + '%' AS 利润率同比变化,\n    row_number() over(order by t2025.收入 desc) as 收入排名,\n    row_number() over(order by t2025.利润 desc) as 利润排名\n\nFROM \n    (\n        SELECT \n            省办,\n            SUM(均摊主营业务收入) AS 收入,\n            SUM(均摊利润总额) AS 利润, \n            SUM(均摊利润总额)/NULLIF(SUM(均摊主营业务收入), 0) AS 利润率\n        FROM \n            PKUDB.dbo.bi_lyx_zhihui_xuanpin_data_all\n        WHERE \n            月份 BETWEEN {start} AND {end}\n            AND 通路 = {qudao}\n        GROUP BY \n            省办\n    ) t2025\nFULL JOIN \n    (\n        SELECT \n            省办,\n            SUM(均摊主营业务收入) AS 收入,\n            SUM(均摊利润总额) AS 利润, \n            SUM(均摊利润总额)/NULLIF(SUM(均摊主营业务收入), 0) AS 利润率\n        FROM \n            PKUDB.dbo.bi_lyx_zhihui_xuanpin_data_all\n        WHERE \n            月份 BETWEEN {prev_start} AND {prev_end}\n            AND 通路 = {qudao}\n        GROUP BY \n            省办\n    ) t2024\nON \n    t2025.省办 = t2024.省办\nWHERE (t2025.收入 <> 0 AND t2024.收入 <> 0)\n"
    ],
    "销售利润情况": [
        "\nSELECT \n        省办,\n        SUM(均摊主营业务收入) AS 收入,\n        sum(sku终端成本) as 成本,\n        SUM(均摊销售费用) as 销售费用,\n        SUM(均摊管理费用) AS 管理费用,\n        sum(均摊S费用) as S费用,\n        sum(均摊M费用) as M费用,\n        sum(均摊D费用) as D费用,\n        sum(均摊利润总额) as 利润,\n        sum(均摊利润总额)/nullif(sum(均摊主营业务收入),0) as 利润率,\n        sum(sku终端成本)/nullif(sum(均摊主营业务收入),0) as 成本率,\n        sum(均摊销售费用) /sum(均摊主营业务收入) 销售费用率,\n        sum(均摊管理费用) /sum(均摊主营业务收入) 管理费用率,\n        sum(均摊S费用)/sum(均摊主营业务收入)    S费率,\n        sum(均摊M费用)/sum(均摊主营业务收入)   M费率,\n        sum(均摊D费用)/sum(均摊主营业务收入)    D费率\nFROM \nPKUDB.dbo.bi_lyx_zhihui_xuanpin_data_all\nWHERE \n月份 BETWEEN {start} AND {end}\nAND 通路 = {qudao} and 省办={shengban}\ngroup by 省办\n\n",
        "\nSELECT \n    营业所,\n    SUM(均摊主营业务收入) AS 收入,\n    SUM(sku终端成本) AS 成本,\n    SUM(均摊销售费用) AS 销售费用,\n    SUM(均摊管理费用) AS 管理费用,\n    SUM(均摊S费用) AS S费用,\n    SUM(均摊M费用) AS M费用,\n    SUM(均摊D费用) AS D费用,\n    SUM(均摊利润总额) AS 利润,\n    SUM(均摊利润总额) / NULLIF(SUM(均摊主营业务收入), 0) AS 利润率,\n    SUM(sku终端成本) / NULLIF(SUM(均摊主营业务收入), 0) AS 成本率,\n    SUM(均摊销售费用) / NULLIF(SUM(均摊主营业务收入), 0) AS 销售费用率,\n    SUM(均摊管理费用) / NULLIF(SUM(均摊主营业务收入), 0) AS 管理费用率,\n    SUM(均摊S费用) / NULLIF(SUM(均摊主营业务收入), 0) AS S费率,\n    SUM(均摊M费用) / NULLIF(SUM(均摊主营业务收入), 0) AS M费率,\n    SUM(均摊D费用) / NULLIF(SUM(均摊主营业务收入), 0) AS D费率,\n    SUM(均摊主营业务收入) / SUM(SUM(均摊主营业务收入)) OVER () AS 收入占比\nFROM \n    PKUDB.dbo.bi_lyx_zhihui_xuanpin_data_all\nWHERE \n    月份 BETWEEN {start} AND {end}\n    AND 通路 = {qudao} \n    AND 省办 = {shengban}\nGROUP BY \n    营业所\norder by SUM(均摊主营业务收入) desc;\n"
    ],
    "省办排名查询": [
        "\nWITH SalesAndProfit AS (\n    SELECT\n        省办,\n        SUM(均摊主营业务收入) AS 总销额,\n        SUM(均摊利润总额) AS 总利润\n    FROM\n        bi_lyx_zhihui_xuanpin_data_all\n    WHERE\n        通路 = {qudao}\n        AND 月份 BETWEEN {start} AND {end} -- 修改为你的起始和结束月份\n    GROUP BY\n        省办\n),\nRankedSales AS (\n    SELECT\n        省办,\n        总销额,\n        总利润,\n        CAST(总利润 AS FLOAT) / NULLIF(总销额, 0) * 100 AS 利润率,\n        ROW_NUMBER() OVER (ORDER BY 总销额 DESC) AS 销额排名,\n        ROW_NUMBER() OVER (ORDER BY 总销额 ASC) AS 销额倒序排名\n    FROM\n        SalesAndProfit\n),\nRankedProfit AS (\n    SELECT\n        省办,\n        总销额,\n        总利润,\n        CAST(总利润 AS FLOAT) / NULLIF(总销额, 0) * 100 AS 利润率,\n        ROW_NUMBER() OVER (ORDER BY 总利润 DESC) AS 利润排名,\n        ROW_NUMBER() OVER (ORDER BY 总利润 ASC) AS 利润倒序排名\n    FROM\n        SalesAndProfit\n),\nTopAndBottomSales AS (\n    SELECT\n        省办,\n        总销额,\n        总利润,\n        利润率,\n        销额排名,\n        NULL AS 利润排名\n    FROM\n        RankedSales\n    WHERE\n        销额排名 <= {n} OR 销额倒序排名 <= {n}\n),\nTopAndBottomProfit AS (\n    SELECT\n        省办,\n        总销额,\n        总利润,\n        利润率,\n        NULL AS 销额排名,\n        利润排名\n    FROM\n        RankedProfit\n    WHERE\n        利润排名 <= {n} OR 利润倒序排名 <= {n}\n)\nSELECT DISTINCT\n    COALESCE(s.省办, p.省办) AS 省办名称,\n    COALESCE(s.总利润, p.总利润) AS 利润,\n    COALESCE(s.总销额, p.总销额) AS 收入,\n    COALESCE(s.利润率, p.利润率) AS 利润率,\n    COALESCE(p.利润排名, 0) AS 利润排名,\n    COALESCE(s.销额排名, 0) AS 收入排名\nFROM\n    TopAndBottomSales s\nFULL OUTER JOIN\n    TopAndBottomProfit p\nON\n    s.省办 = p.省办\nORDER BY\n    省办名称;\n"
    ],
    "物料成本": [
        "\nSELECT 月份, 物料编码, 物料代码, 物料名称,\n一级品类, 一级系列, 长度, 宽度, 抽数片数,层数,净含量克重, 香味, \nROUND(大分摊口径_一包成本价_元, 2) AS 大分摊口径_一包成本价_元, \nROUND(大分摊口径_一提成本价_元, 2) AS 大分摊口径_一提成本价_元, \nROUND(大分摊口径_一件成本价_元, 2) AS 大分摊口径_一件成本价_元,\nROUND(大分摊口径_吨成本金额_元, 2) AS 大分摊口径_吨成本金额_元\nFROM \nbi_zjf_zhihui_xuanpin_sku_chengben\nWHERE 物料代码={wuliao}\n"
    ],
    "品类盈利亏损": [
        "\nSELECT \n        省办, \n        一级品类, \n        二级品类, \n        FORMAT(SUM(折后未税收入_成本明细), 'N') as 收入, \n        FORMAT(SUM(op额), 'N') as 利润,\n        FORMAT(SUM(op额)/NULLIF(SUM(折后未税收入_成本明细), 0) * 100, 'N2') + '%' as 利润率,\n        FORMAT(SUM(折后未税收入_成本明细)/SUM(SUM(折后未税收入_成本明细)) OVER() * 100, 'N2') + '%' as 收入占比\nFROM \n    PKUDB.dbo.bi_lyx_zhihui_xuanpin_data_all\nWHERE \n    月份 BETWEEN {start} AND {end}\nAND 省办 = {shengban}\nAND 折后未税收入_成本明细 <> 0\nGROUP BY 省办, 一级品类, 二级品类\nORDER BY SUM(折后未税收入_成本明细) DESC\n"
    ],
    "品类结构变化": [
        "\n-- 使用 CTE 对原查询进行封装\nWITH MonthlyMetrics AS (\n    SELECT \n        一级品类,\n        二级品类,\n        -- 收入指标计算\n        SUM(CASE WHEN 月份 = {start} THEN 均摊主营业务收入 ELSE 0 END) AS [{start}收入],\n        CASE WHEN SUM(CASE WHEN 月份 = {start} THEN 均摊主营业务收入 ELSE 0 END) <> 0 \n             THEN SUM(CASE WHEN 月份 = {start} THEN 均摊主营业务收入 ELSE 0 END) / SUM(SUM(CASE WHEN 月份 = {start} THEN 均摊主营业务收入 ELSE 0 END)) OVER () \n             ELSE 0 END AS [{start}收入占比],\n        SUM(CASE WHEN 月份 = {middle} THEN 均摊主营业务收入 ELSE 0 END) AS [{middle}收入],\n        -- 计算收入占比\n        CASE WHEN SUM(CASE WHEN 月份 = {middle} THEN 均摊主营业务收入 ELSE 0 END) <> 0 \n             THEN SUM(CASE WHEN 月份 = {middle} THEN 均摊主营业务收入 ELSE 0 END) / SUM(SUM(CASE WHEN 月份 = {middle} THEN 均摊主营业务收入 ELSE 0 END)) OVER () \n             ELSE 0 END AS [{middle}收入占比],\n        SUM(CASE WHEN 月份 = {end} THEN 均摊主营业务收入 ELSE 0 END) AS [{end}收入],\n        -- 计算收入占比\n        CASE WHEN SUM(CASE WHEN 月份 = {end} THEN 均摊主营业务收入 ELSE 0 END) <> 0 \n             THEN SUM(CASE WHEN 月份 = {end} THEN 均摊主营业务收入 ELSE 0 END) / SUM(SUM(CASE WHEN 月份 = {end} THEN 均摊主营业务收入 ELSE 0 END)) OVER () \n             ELSE 0 END AS [{end}收入占比],\n        -- 利润指标计算\n        SUM(CASE WHEN 月份 = {start} THEN 均摊利润总额 ELSE 0 END) AS [{start}利润],\n        SUM(CASE WHEN 月份 = {middle} THEN 均摊利润总额 ELSE 0 END) AS [{middle}利润],\n        SUM(CASE WHEN 月份 = {end} THEN 均摊利润总额 ELSE 0 END) AS [{end}利润],\n        -- 利润率指标\n        -- 避免除数为 0 的情况\n        CASE WHEN SUM(CASE WHEN 月份 = {start} THEN 均摊主营业务收入 ELSE 0 END) <> 0 \n             THEN SUM(CASE WHEN 月份 = {start} THEN 均摊利润总额 ELSE 0 END) / SUM(CASE WHEN 月份 = {start} THEN 均摊主营业务收入 ELSE 0 END) \n             ELSE 0 END AS [{start}利润率],\n        CASE WHEN SUM(CASE WHEN 月份 = {middle} THEN 均摊主营业务收入 ELSE 0 END) <> 0 \n             THEN SUM(CASE WHEN 月份 = {middle} THEN 均摊利润总额 ELSE 0 END) / SUM(CASE WHEN 月份 = {middle} THEN 均摊主营业务收入 ELSE 0 END) \n             ELSE 0 END AS [{middle}利润率],\n        CASE WHEN SUM(CASE WHEN 月份 = {end} THEN 均摊主营业务收入 ELSE 0 END) <> 0 \n             THEN SUM(CASE WHEN 月份 = {end} THEN 均摊利润总额 ELSE 0 END) / SUM(CASE WHEN 月份 = {end} THEN 均摊主营业务收入 ELSE 0 END) \n             ELSE 0 END AS [{end}利润率],\n        -- 毛利率\n        CASE \n            WHEN ISNULL(SUM(CASE WHEN 月份 = {end} THEN 折后未税收入_成本明细 ELSE 0 END), 0) <> 0 \n                THEN CASE \n                    WHEN SUM(CASE WHEN 月份 = {end} THEN 折后未税收入_成本明细 ELSE 0 END) < 0 \n                        THEN -1 - (SUM(CASE WHEN 月份 = {end} THEN sku终端成本 ELSE 0 END) / ABS(SUM(CASE WHEN 月份 = {end} THEN 折后未税收入_成本明细 ELSE 0 END)))\n                    WHEN SUM(CASE WHEN 月份 = {end} THEN 折后未税收入_成本明细 ELSE 0 END) > 0 \n                        THEN 1 - (SUM(CASE WHEN 月份 = {end} THEN sku终端成本 ELSE 0 END) / SUM(CASE WHEN 月份 = {end} THEN 折后未税收入_成本明细 ELSE 0 END))\n                    ELSE 0 \n                END \n            ELSE 0 \n        END AS [{end}毛利率]\n    FROM \n        bi_lyx_zhihui_xuanpin_data_all\n    WHERE \n        基本数量 <> 0   \n        AND 折后未税收入_成本明细 <> 0 \n        AND sku终端成本 <> 0\n        AND 月份 BETWEEN {start} AND {end}\n        AND 通路 = {qudao} \n        AND 省办 = {shengban}\n    GROUP BY \n        一级品类,\n        二级品类\n)\n-- 主查询，对毛利率分层并进行左连接\nSELECT \n    mm.一级品类,\n    mm.二级品类,\n    mm.[{start}收入],\n    mm.[{start}收入占比],\n    mm.[{middle}收入],\n    mm.[{middle}收入占比],\n    mm.[{end}收入],\n    mm.[{end}收入占比],\n    mm.[{start}利润],\n    mm.[{middle}利润],\n    mm.[{end}利润],\n    mm.[{start}利润率],\n    mm.[{middle}利润率],\n    mm.[{end}利润率],\n    mm.[{end}毛利率],\n    -- 对 {end} 毛利率进行分层\n    CASE \n        WHEN mm.[{end}毛利率] < 0.1 THEN '1-10%'\n        WHEN mm.[{end}毛利率] < 0.2 THEN '11-20%'\n        WHEN mm.[{end}毛利率] < 0.3 THEN '21-30%'\n        WHEN mm.[{end}毛利率] < 0.4 THEN '31-40%'\n        WHEN mm.[{end}毛利率] < 0.5 THEN '41-50%'\n        WHEN mm.[{end}毛利率] < 0.6 THEN '51-60%'\n        WHEN mm.[{end}毛利率] < 0.7 THEN '61-70%'\n        WHEN mm.[{end}毛利率] < 0.8 THEN '71-80%'\n        WHEN mm.[{end}毛利率] < 0.9 THEN '81-90%'\n        ELSE '>90%'\n    END AS [{end}毛利率分层],\n    -- 左连接获取毛利等级，若为 NULL 则按规则定义\n    COALESCE(mp.毛利水平, \n        CASE \n            WHEN mm.[{end}毛利率] < 0.3 THEN '低'\n            WHEN mm.[{end}毛利率] < 0.4 THEN '中'\n            ELSE '高'\n        END) AS 毛利等级\nFROM \n    MonthlyMetrics mm\nLEFT JOIN \n    PROJ_北京大学智慧营销项目_产品二级品类_毛利划分等级 mp\nON \n    mm.二级品类 = mp.二级品类\n    AND CASE \n        WHEN mm.[{end}毛利率] < 0.1 THEN '1-10%'\n        WHEN mm.[{end}毛利率] < 0.2 THEN '11-20%'\n        WHEN mm.[{end}毛利率] < 0.3 THEN '21-30%'\n        WHEN mm.[{end}毛利率] < 0.4 THEN '31-40%'\n        WHEN mm.[{end}毛利率] < 0.5 THEN '41-50%'\n        WHEN mm.[{end}毛利率] < 0.6 THEN '51-60%'\n        WHEN mm.[{end}毛利率] < 0.7 THEN '61-70%'\n        WHEN mm.[{end}毛利率] < 0.8 THEN '71-80%'\n        WHEN mm.[{end}毛利率] < 0.9 THEN '81-90%'\n        ELSE '>90%'\n    END = mp.毛利分层\nORDER BY \n    mm.[{end}收入] DESC;    \n"
    ]
}